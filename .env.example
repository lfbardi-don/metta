# ===========================================
# SERVER CONFIGURATION
# ===========================================
PORT=3000
NODE_ENV=development

# ===========================================
# WORKER CONFIGURATION
# ===========================================
# Enable/disable worker (set to false to disable SQS processing)
WORKER_ENABLED=true

# Graceful shutdown timeout (milliseconds)
GRACEFUL_SHUTDOWN_TIMEOUT=30000

# Message Batching Configuration
# When enabled, messages from the same conversation that arrive within
# MESSAGE_BATCH_DELAY_MS are grouped together and processed with a single AI response.
# Benefits: Better conversation coherence, reduced API calls, cost savings.
#
# Debouncing Behavior:
# - Timer resets on each new message (waits DELAY_MS after LAST message)
# - BUT max wait time (MAX_WAIT_MS) prevents SQS receipt handle expiration
# - Processes after: "DELAY_MS of silence" OR "MAX_WAIT_MS since first message"
MESSAGE_BATCH_ENABLED=true          # Enable/disable batching (default: true)
MESSAGE_BATCH_DELAY_MS=5000         # Batch window in milliseconds (default: 5000 = 5 seconds)
MESSAGE_BATCH_MAX_WAIT_MS=20000     # Max wait time since first message (default: 20000 = 20 seconds)
                                    # MUST be < SQS_VISIBILITY_TIMEOUT to prevent receipt handle expiration

# ===========================================
# OPENAI API CONFIGURATION
# ===========================================
OPENAI_API_KEY=your_openai_api_key_here

# ===========================================
# AI SYSTEM SELECTION (Feature Flag)
# ===========================================
# Choose which AI system to use for message processing
# false = Current multi-agent system with bidirectional handoffs (default)
# true  = New workflow system with explicit classifier and MCP tools
USE_WORKFLOW_AI=false

# Workflow Configuration (only applies when USE_WORKFLOW_AI=true)
# MCP Server URLs for hosted tool integration
MCP_ORDERS_URL=https://nuvemshop-orders.luisfbardi.workers.dev/sse
MCP_PRODUCTS_URL=https://nuvemshop-products.luisfbardi.workers.dev/sse

# OpenAI Vector Store ID for FAQ Agent file search
OPENAI_VECTOR_STORE_ID=vs_6908fd1143388191af50558c88311abf

# Workflow tracing and observability
WORKFLOW_TRACE_ENABLED=true
WORKFLOW_ID=wf_6908c91cd5ac8190baa31b1799154da102aeda53012b0c18

# Authentication for Workflow
# Authentication is implemented in MCP Orders server using Cloudflare KV for session storage
# Sessions last 30 minutes with automatic expiration (TTL)
# DNI verification: Customer provides email + last 3 digits of DNI
# MCP server looks up customer in Nuvemshop, extracts DNI, compares digits
# If match → Creates KV session, allows access to protected order tools

# ===========================================
# DATABASE CONFIGURATION (Neon PostgreSQL)
# ===========================================
# Get this from: https://console.neon.tech/
DATABASE_URL=postgresql://user:password@host/database?sslmode=require

# ===========================================
# AWS SQS CONFIGURATION
# ===========================================
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_aws_access_key_id
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
SQS_QUEUE_URL=https://sqs.us-east-1.amazonaws.com/123456789/your-queue-name

# SQS Polling Configuration
SQS_MAX_MESSAGES=10           # Max messages per poll (1-10)
SQS_WAIT_TIME_SECONDS=20      # Long polling duration (0-20)
SQS_VISIBILITY_TIMEOUT=30     # Processing timeout before retry (seconds)
SQS_MAX_RETRIES=3             # Max retry attempts

# ===========================================
# CHATWOOT CONFIGURATION
# ===========================================
# API Configuration (for sending messages)
CHATWOOT_API_URL=https://app.chatwoot.com
CHATWOOT_API_KEY=your_chatwoot_api_key
CHATWOOT_ACCOUNT_ID=your_account_id

# Note: Webhooks are received by AWS Lambda, not this worker
# This worker only SENDS messages to Chatwoot

# ===========================================
# PRODUCT INTEGRATION SELECTION
# ===========================================
# Choose which e-commerce platform to use for product data
# Options: 'nuvemshop' or 'odoo'
# This allows switching between integrations without code changes
PRODUCT_INTEGRATION=nuvemshop

# ===========================================
# ODOO CONFIGURATION
# ===========================================
ODOO_URL=https://your-company.odoo.com
ODOO_DATABASE=your_database_name
ODOO_USERNAME=your_odoo_username
ODOO_PASSWORD=your_odoo_password

# Optional: API Key (if using API key authentication instead)
# ODOO_API_KEY=your_odoo_api_key

# ===========================================
# NUVEMSHOP/TIENDANUBE CONFIGURATION
# ===========================================
# Nuvemshop (Brasil): https://api.nuvemshop.com.br/v1
# Tiendanube (Argentina/LATAM): https://api.tiendanube.com/v1
NUVEMSHOP_API_URL=https://api.nuvemshop.com.br/v1
NUVEMSHOP_STORE_ID=
NUVEMSHOP_ACCESS_TOKEN=
NUVEMSHOP_USER_AGENT=AppName (email@gmail.com)

# Optional: Preferred language for multi-language fields (pt, es, or en)
# Default: pt (Portuguese)
NUVEMSHOP_LANGUAGE=pt

# Product Images
# Products are automatically formatted by AI with inline images using markdown syntax
# AI follows card-style template defined in PRODUCTS_PROMPT
# Images use direct URLs from Nuvemshop (no download/upload required)
# Format: ![Product Name](https://d2r9epyceweg5n.cloudfront.net/...)
# Chatwoot web widget renders markdown images inline automatically
# Limited to top 3 products per response for optimal UX

# ===========================================
# GUARDRAILS CONFIGURATION
# ===========================================
# Enable/disable specific guardrails
GUARDRAILS_ENABLE_PII_CHECK=true
GUARDRAILS_ENABLE_TOXICITY_CHECK=true
GUARDRAILS_ENABLE_INJECTION_CHECK=true
GUARDRAILS_ENABLE_BUSINESS_RULES=true

# PII Detection with Metadata Extraction
# When enabled, PII (email, phone, DNI, credit cards, SSN) is detected and:
# - Replaced with indexed placeholders in conversation ([EMAIL_1], [DNI_1], etc.)
# - Real values stored in metadata and automatically resolved for Odoo tool calls
# - Output checked for leaks and re-sanitized before sending to user
# Supported: email, phone, credit card, SSN (US), DNI (Argentina)

# LLM-based output guardrails (use gpt-4o-mini)
# Cost: ~$0.0002 per check | Latency: ~200-500ms each
GUARDRAILS_ENABLE_TONE_CHECK=true           # Professional tone validation
GUARDRAILS_ENABLE_RELEVANCE_CHECK=true      # Response relevance validation
GUARDRAILS_LLM_TIMEOUT=5000                 # Timeout for LLM guardrail calls (ms)

# Toxicity threshold (0-1, higher = more strict)
GUARDRAILS_TOXICITY_THRESHOLD=0.7

# OpenAI Moderation API Configuration
OPENAI_MODERATION_TIMEOUT=5000          # Timeout for moderation API calls (ms)
GUARDRAILS_MODERATION_FALLBACK=warn     # Behavior if API fails: warn|block

# ===========================================
# AUTHENTICATION CONFIGURATION
# ===========================================
# Enable/disable customer authentication for accessing private order data
AUTH_ENABLED=true                        # Enable authentication (default: true)

# Session configuration
AUTH_SESSION_DURATION_MINUTES=30         # Session duration after successful verification (default: 30)
AUTH_DNI_DIGITS=3                        # Number of DNI digits to verify (default: 3)

# DNI Verification Flow:
# 1. Customer asks about orders → AI checks auth status
# 2. If not authenticated → AI asks for email + last N digits of DNI
# 3. System looks up customer by email in Nuvemshop/Odoo
# 4. Verifies DNI digits match customer records
# 5. Creates 30-minute session if match
# 6. Protected tools (orders, tracking, payment) check session before execution
